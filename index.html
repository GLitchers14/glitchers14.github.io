<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>GLitchers14 (ANGLE Review Tracker)</title>
<style>
  :root{--bg:#0b0f13;--panel:#121822;--border:#1f2a37;--text:#e5eef6;--sub:#92a3b5;--accent:#5eead4;--muted:#74869a}

  /* ---- 레이아웃: 푸터 하단 고정 ---- */
  html,body{height:100%}
  body{
    margin:0;
    background:var(--bg);
    color:var(--text);
    font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto;
    display:flex; flex-direction:column; min-height:100vh;
  }
  #root{display:flex; flex-direction:column; flex:1}
  .wrap{max-width:1200px;margin:0 auto;padding:16px; flex:1}

  .card{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:12px}
  .row{display:flex;align-items:center;gap:8px}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}
  .btn{border:1px solid var(--border);border-radius:10px;padding:6px 10px;background:#0f141b;color:var(--text);cursor:pointer}
  input{background:#0f141b;border:1px solid var(--border);color:var(--text);border-radius:8px;padding:6px 8px;outline:none}
  .grid{display:grid;grid-template-columns:1fr 2fr; gap:16px}
  @media (max-width:1100px){.grid{grid-template-columns:1fr}}
  .tree{max-height:72vh;overflow:auto}
  .fullpath{word-break:break-all}
  .badge{font-size:12px;color:var(--sub)}
  .donut{width:140px;height:140px}
  .dirrow{display:flex;align-items:center;gap:8px;padding:4px 6px;border-radius:8px;user-select:none}
  .filerow{display:flex;align-items:center;justify-content:space-between;gap:8px;padding:6px 8px;border-radius:8px}
  .caret{display:inline-block;width:1em;text-align:center}
  .switch{position:relative;display:inline-block;width:44px;height:24px}
  .switch input{opacity:0;width:0;height:0}
  .slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background:#243142;border:1px solid var(--border);transition:.2s;border-radius:999px}
  .slider:before{position:absolute;content:"";height:18px;width:18px;left:3px;top:2px;background:#d0d8e3;transition:.2s;border-radius:50%}
  .switch input:checked + .slider{background:#0b2a22;border-color:#134e4a}
  .switch input:checked + .slider:before{transform:translateX(20px)}
  .btable{width:100%;border-collapse:separate;border-spacing:0 6px;margin-top:12px}
  .bname{white-space:nowrap}
  .bbar{height:10px;background:#14202a;border:1px solid #233645;border-radius:999px;overflow:hidden}
  .bfill{height:100%;background:linear-gradient(90deg,#0ea5e9,#22c55e)}
  .bright{font-variant-numeric:tabular-nums}

  /* ---- footer ---- */
  footer{
    background:var(--panel);
    border-top:1px solid var(--border);
    color:var(--muted);
    padding:10px 16px;
  }
  footer .inner{max-width:1200px;margin:0 auto}
</style>
</head>
<body>
<div id="root">
  <div class="wrap">
    <h1>ANGLE Review Tracker — GLitchers14</h1>

    <div class="card" style="margin-bottom:12px">
      <div class="row" style="flex-wrap:wrap;gap:10px">
        <span class="badge">repo</span>
        <input id="repo" class="mono" style="min-width:240px" placeholder="owner/repo" value="google/angle"/>
        <span class="badge">branch</span>
        <input id="branch" class="mono" style="min-width:120px" placeholder="main" value="main"/>
        <button id="apply" class="btn">Apply</button>
        <span id="shaBadge" class="badge"></span>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <h2 style="margin-top:6px">Progress</h2>
        <div class="row" style="justify-content:space-between;align-items:flex-start">
          <div>
            <div class="row"><span class="badge">Total </span><span id="total" class="mono">—</span></div>
            <div class="row"><span class="badge">Reviewed</span><span id="rev" class="mono">—</span></div>
            <div class="row"><span class="badge">Percent</span><span id="pctText" class="mono">—%</span></div>
          </div>
          <svg id="donut" class="donut" viewBox="0 0 120 120" aria-label="progress donut">
            <circle cx="60" cy="60" r="50" fill="none" stroke="#16202b" stroke-width="14"></circle>
            <circle id="donutFill" cx="60" cy="60" r="50" fill="none" stroke="var(--accent)" stroke-width="14"
                    stroke-dasharray="314.159" stroke-dashoffset="314.159" transform="rotate(-90 60 60)"></circle>
            <text id="donutText" x="60" y="66" text-anchor="middle" font-size="20" font-weight="700" fill="#cde9ff">—%</text>
          </svg>
        </div>

        <h3 style="margin:12px 0 6px">Backends</h3>
        <table class="btable" id="backendTable" aria-label="backend progress table"></table>

        <div id="err" style="white-space:pre-wrap;color:#fecaca;margin-top:8px"></div>
      </div>

      <div class="card tree">
        <div class="row" style="justify-content:space-between;align-items:center;margin-bottom:6px">
          <h2 style="margin:0">ANGLE Source Tree</h2>
          <label class="row" title="Only show files that are not reviewed yet" style="gap:10px">
            <span class="badge">show only unchecked</span>
            <span class="switch"><input type="checkbox" id="onlyU"/><span class="slider"></span></span>
          </label>
        </div>
        <div id="tree"></div>
      </div>
    </div>
  </div>

  <!-- footer는 #root 안, .wrap 뒤 -->
  <footer>
    <div class="inner">
      <p>© 2025 tb4nch0r. All rights reserved.</p>
    </div>
  </footer>
</div>

<script>
/* ===== constants / storage ===== */
const GH_VER='2022-11-28';
const LS_DB='angle-review-tracker/whitelist-tree.v4';
const $=id=>document.getElementById(id);
const DEFAULT_DB={repo:'google/angle',branch:'main',reviews:{},meta:{version:4,updatedAt:0}};

function norm(p){
  return String(p||'')
    .replace(/^third_party\/angle\//,'')
    .replace(/^angle\//,'')
    .replace(/^\/+/, '');
}
function base(p){ const i=String(p).lastIndexOf('/'); return i>=0? p.slice(i+1): String(p); }
function clone(o){return JSON.parse(JSON.stringify(o));}
function loadDB(){ try{const raw=localStorage.getItem(LS_DB); return raw?JSON.parse(raw):clone(DEFAULT_DB);}catch{return clone(DEFAULT_DB)} }
function saveDB(db){ db.meta=db.meta||{}; db.meta.updatedAt=Date.now(); localStorage.setItem(LS_DB,JSON.stringify(db)); }

const LEGACY_LS_KEYS=[
  'angle-review-tracker/db.whitelist.v1',
  'angle-review-tracker/db.whitelist.v2',
  'angle-review-tracker/whitelist-tree.v1',
  'angle-review-tracker/whitelist-tree.v2',
  'angle-review-tracker/whitelist-tree.v3'
];
async function tryImportServerStateOnce(){
  try{
    const r=await fetch('/state'); if(!r.ok) return false;
    const obj=await r.json(); if(obj && obj.reviews){ mergeReviewsIntoDB(obj); return true; }
  }catch{}
  return false;
}
function mergeReviewsIntoDB(fromObj){
  if(!fromObj || typeof fromObj!=='object') return;
  const src=(fromObj.reviews && typeof fromObj.reviews==='object')?fromObj.reviews:{};
  DB.reviews=DB.reviews||{};
  for(const k in src){
    const v=src[k]; if(v && v.checked){
      const nk=norm(k);
      DB.reviews[nk]={checked:true,ts:v.ts||new Date().toISOString()};
      const bk=base(nk);
      DB.reviews[bk]=DB.reviews[bk]||{checked:true,ts:DB.reviews[nk].ts};
    }
  }
  saveDB(DB);
}
async function importLegacyOnce(){
  let imported=false;
  for(const key of LEGACY_LS_KEYS){
    try{ const raw=localStorage.getItem(key); if(!raw) continue; mergeReviewsIntoDB(JSON.parse(raw)); imported=true; }catch{}
  }
  const s=await tryImportServerStateOnce(); imported = imported || s;
  return imported;
}

/* ===== global ===== */
let DB=loadDB();
let SHA=null;
let WL_FILES=[]; // normalized
let TREE=null;

/* ===== GitHub proxy ===== */
function gh(path){
  const u=location.origin+'/gh/'+path.replace(/^\/+/, '');
  return fetch(u,{headers:{'Accept':'application/vnd.github+json','X-GitHub-Api-Version':GH_VER}})
    .then(r=>r.ok?r.json():r.text().then(t=>{throw new Error(r.status+' '+r.statusText+' :: '+t)}));
}
async function resolveSHA(owner,repo,branch){
  try{
    const j=await gh(`repos/${owner}/${repo}/git/refs/heads/${encodeURIComponent(branch)}`);
    return (j && j.object && j.object.sha) ? j.object.sha : branch;
  }catch{ return branch; }
}

/* ===== whitelist & excludes (.cpp + .mm) ===== */
const WL_INCLUDE_DIRS=[
  'src/compiler/translator/',
  'src/libANGLE/',
  'src/libANGLE/renderer/d3d/',
  'src/libANGLE/renderer/gl/',
  'src/libANGLE/renderer/vulkan/',
  'src/libANGLE/renderer/metal/'
];
const WL_DENY_SUBDIRS=[
  // translator
  'src/compiler/translator/ir/','src/compiler/translator/msl/','src/compiler/translator/tree_ops/','src/compiler/translator/apple/','src/compiler/translator/tree_util/','src/compiler/translator/wgsl/','src/compiler/translator/capture/',
  // libANGLE capture & non-scope renderers
  'src/libANGLE/capture/','src/libANGLE/renderer/cl/','src/libANGLE/renderer/null/','src/libANGLE/renderer/wgpu/',
  // GL platform layers (데스크톱/플랫폼 종속)
  'src/libANGLE/renderer/gl/cgl/','src/libANGLE/renderer/gl/egl/','src/libANGLE/renderer/gl/glx/','src/libANGLE/renderer/gl/wgl/','src/libANGLE/renderer/gl/egl/android/',
  // Vulkan 비스코프
  'src/libANGLE/renderer/vulkan/android/','src/libANGLE/renderer/vulkan/fuchsia/','src/libANGLE/renderer/vulkan/null/','src/libANGLE/renderer/vulkan/win32/',
  'src/libANGLE/renderer/vulkan/linux/display/','src/libANGLE/renderer/vulkan/linux/gbm/','src/libANGLE/renderer/vulkan/linux/headless/','src/libANGLE/renderer/vulkan/linux/healess/','src/libANGLE/renderer/vulkan/linux/wayland/','src/libANGLE/renderer/vulkan/linux/xcb/',
  // Metal 제외
  'src/libANGLE/renderer/metal/file_hooking/'
];
function inInclude(p){ return WL_INCLUDE_DIRS.some(pre=>p.startsWith(pre)); }
function inDeny(p){ return WL_DENY_SUBDIRS.some(pre=>p.startsWith(pre)); }
function isCppOrMM(p){ return /\.(cpp|mm)$/i.test(p); }
function allowedPath(raw){ const p=norm(raw); return inInclude(p) && !inDeny(p) && isCppOrMM(p); }

/* ===== donut ===== */
function setDonut(pct){
  const c=2*Math.PI*50;
  if(typeof pct!=='number'){ $('donutFill').setAttribute('stroke-dashoffset', String(c)); $('donutText').textContent='—%'; $('pctText').textContent='—%'; return; }
  $('donutFill').setAttribute('stroke-dashoffset', String(c*(1-pct)));
  const t=Math.round(pct*100);
  $('donutText').textContent=t+'%'; $('pctText').textContent=t+'%';
}

/* ===== tree build/render ===== */
function buildTree(paths){
  const root={name:'',type:'dir',children:new Map(),total:0,rev:0,full:''};
  function addPath(p){
    const parts=p.split('/'); let cur=root, acc=[];
    for(let i=0;i<parts.length;i++){
      const name=parts[i]; acc.push(name); const last=i===parts.length-1;
      if(last){ cur.children.set(name,{name,type:'file',full:acc.join('/'),total:1,rev:0}); }
      else{ if(!cur.children.has(name)) cur.children.set(name,{name,type:'dir',children:new Map(),full:acc.join('/'),total:0,rev:0}); cur=cur.children.get(name); }
    }
  }
  paths.forEach(addPath);
  function fold(n){
    if(n.type==='file'){ n.rev=isReviewed(n.full)?1:0; n.total=1; return; }
    let t=0,r=0; const kids=[...n.children.values()].sort((a,b)=> (a.type!==b.type)?(a.type==='dir'?-1:1):a.name.localeCompare(b.name));
    n.childrenList=kids; kids.forEach(k=>{fold(k); t+=k.total; r+=k.rev;}); n.total=t; n.rev=r;
  }
  fold(root); return root;
}
function renderTree(){
  const holder=$('tree'); holder.innerHTML='';
  function renderNode(node, parent){
    if(node.type==='file'){
      const row=document.createElement('div'); row.className='filerow';
      const left=document.createElement('label'); left.className='row'; left.style.minWidth='0';
      const cb=document.createElement('input'); cb.type='checkbox'; cb.checked=isReviewed(node.full);
      cb.addEventListener('change',e=>mark(node.full, e.target.checked));
      const name=document.createElement('span'); name.className='mono fullpath'; name.textContent=node.name;
      left.appendChild(cb); left.appendChild(name);
      const badge=document.createElement('span'); badge.className='badge'; badge.textContent=cb.checked?'✅ reviewed':'⬜ unchecked';
      cb.addEventListener('change',()=>{ badge.textContent=cb.checked?'✅ reviewed':'⬜ unchecked'; });
      row.appendChild(left); row.appendChild(badge);
      parent.appendChild(row); return;
    }
    const box=document.createElement('div');
    const head=document.createElement('div'); head.className='dirrow';
    const caret=document.createElement('span'); caret.className='caret'; caret.textContent='▸';
    const title=document.createElement('span'); title.style.fontWeight='600'; title.textContent=node.name||'/';
    const count=document.createElement('span'); count.className='badge'; count.textContent=`${node.rev}/${node.total} files reviewed`;
    head.appendChild(caret); head.appendChild(title); head.appendChild(count);
    const body=document.createElement('div'); body.style.marginLeft='18px'; body.style.display='none';
    let open=false; head.addEventListener('click',()=>{open=!open; caret.textContent=open?'▾':'▸'; body.style.display=open?'':'none';});
    box.appendChild(head); box.appendChild(body); parent.appendChild(box);
    (node.childrenList||[]).forEach(ch=>renderNode(ch,body));
    box.__count=count; box.__body=body; box.__node=node;
  }
  renderNode(TREE, holder);
  applyOnlyUnchecked();
}

/* ===== only-unchecked ===== */
function applyOnlyUnchecked(){
  const onlyU=$('onlyU').checked;
  function walk(node, el){
    if(node.type==='file'){
      el.style.display = (!onlyU || !isReviewed(node.full)) ? '' : 'none';
      return;
    }
    const body=el.__body, kids=node.childrenList||[]; let shown=0;
    for(let i=0;i<kids.length;i++){ const childEl=body.children[i]; walk(kids[i], childEl); if(childEl.style.display!=='none') shown++; }
    el.style.display = shown>0 ? '' : 'none';
    el.__count.textContent=`${node.rev}/${node.total} files reviewed`;
  }
  const rootEl=$('tree').children[0]; if(rootEl) walk(TREE, rootEl);
}

/* ===== backend progress ===== */
const BACKENDS={
  d3d:   {label:'D3D',    prefix:'src/libANGLE/renderer/d3d/'},
  metal: {label:'Metal',  prefix:'src/libANGLE/renderer/metal/'},
  vulkan:{label:'Vulkan', prefix:'src/libANGLE/renderer/vulkan/'}
};
function computeBackendStats(){
  const stats={}; for(const k in BACKENDS) stats[k]={total:0,rev:0};
  for(const p of WL_FILES){
    for(const k in BACKENDS){
      if(p.startsWith(BACKENDS[k].prefix)){ stats[k].total++; if(isReviewed(p)) stats[k].rev++; break; }
    }
  }
  return stats;
}
function renderBackendTable(){
  const tbl=$('backendTable'); tbl.innerHTML='';
  const s=computeBackendStats();
  for(const k of ['d3d','metal','vulkan']){
    const st=s[k], label=BACKENDS[k].label;
    const pct=st.total? Math.round(st.rev*100/st.total) : 0;

    const tr=document.createElement('tr');
    const tdL=document.createElement('td'); tdL.className='bname mono'; tdL.textContent=label;
    const tdM=document.createElement('td'); tdM.style.width='100%';
    const bar=document.createElement('div'); bar.className='bbar'; bar.title=`${label}: ${st.rev}/${st.total} (${pct}%)`;
    const fill=document.createElement('div'); fill.className='bfill'; fill.style.width=pct+'%';
    bar.appendChild(fill); tdM.appendChild(bar);
    const tdR=document.createElement('td'); tdR.className='bright mono'; tdR.style.whiteSpace='nowrap'; tdR.textContent=`${pct}%  (${st.rev}/${st.total})`;

    tr.appendChild(tdL); tr.appendChild(tdM); tr.appendChild(tdR);
    tbl.appendChild(tr);
  }
}

/* ===== counts ==== */
function recalcAndPaint(){
  function fold(n){
    if(n.type==='file'){ n.rev=isReviewed(n.full)?1:0; return; }
    let r=0; (n.childrenList||[]).forEach(k=>{fold(k); r+=k.rev;}); n.rev=r;
  }
  fold(TREE);

  $('total').textContent = WL_FILES.length || '—';
  const reviewed = WL_FILES.reduce((a,p)=>a+(isReviewed(p)?1:0),0);
  $('rev').textContent = (reviewed||WL_FILES.length)?reviewed:'—';
  setDonut(WL_FILES.length? reviewed/WL_FILES.length : null);

  renderBackendTable();
  applyOnlyUnchecked();
}

/* ===== review mark ===== */
function isReviewed(p){
  const k=norm(p);
  if(DB.reviews && DB.reviews[k] && DB.reviews[k].checked) return true;
  const b=base(k);
  if(DB.reviews && DB.reviews[b] && DB.reviews[b].checked) return true;
  if(DB.reviews){
    for(const key in DB.reviews){
      if(key.includes('/') && key.endsWith('/'+b) && DB.reviews[key].checked) return true;
    }
  }
  return false;
}
function mark(p, checked){
  const k=norm(p);
  if(checked){
    DB.reviews[k]={checked:true,ts:new Date().toISOString()};
    const b=base(k); DB.reviews[b]=DB.reviews[b]||{checked:true,ts:DB.reviews[k].ts};
  }else{
    delete DB.reviews[k];
  }
  saveDB(DB);
  recalcAndPaint();
}

/* ===== load & render ===== */
function setErr(msg){ $('err').textContent=msg||''; }
async function loadWhitelistAndRender(){
  setErr('');
  const val=$('repo').value.trim(), br=$('branch').value.trim();
  if(!val || !val.includes('/')) throw new Error('repo 형식은 owner/repo');
  if(!br) throw new Error('branch 필요');

  const [owner,repo]=val.split('/');
  const sha=await resolveSHA(owner,repo,br);
  SHA=sha; $('shaBadge').textContent='pinned '+(sha||'').slice(0,7);

  const t=await gh(`repos/${owner}/${repo}/git/trees/${sha}?recursive=1`);
  const all=(t&&t.tree)?t.tree:[];
  WL_FILES = all
    .filter(e=>e.type==='blob' && allowedPath(e.path||''))
    .map(e=>norm(e.path||''))
    .sort();

  TREE=buildTree(WL_FILES);
  renderTree();
  recalcAndPaint();
}

/* ===== UI wiring ===== */
$('apply').addEventListener('click', async ()=>{
  try{
    DB.repo=($('repo').value||'').trim();
    DB.branch=($('branch').value||'').trim();
    saveDB(DB);
    await loadWhitelistAndRender();
  }catch(e){ setErr(String(e)); }
});
$('onlyU').addEventListener('change', applyOnlyUnchecked);

/* ===== init ===== */
(async function init(){
  $('repo').value=DB.repo; $('branch').value=DB.branch;
  await importLegacyOnce();
  await loadWhitelistAndRender();
})();
</script>
</body>
</html>

